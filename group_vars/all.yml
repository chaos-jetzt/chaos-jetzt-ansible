---
users:
- name: 'n0emis'
  state: 'present'
  public_key: 'ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIEcOPtW5FWNIdlMQFoqeyA1vHw+cA8ft8oXSbXPzQNL9'
  sudo: yes
- name: 'em0lar'
  state: 'present'
  public_key: |
    ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAAEAQC5LY2Vp2jWD4O9rPeVHDzVGWS+tnwvguZ32BTu6m3b7XROhikF4UKSHiYF//AtZfuP2xTHTt+XWMzMghEf/GVkhJnA3YImg5+GtVCZwgsxKNs7RY47g6xtj962nxtqPkwUqXJI91QMLPSr5NlsyvImiyJjwNqO6SSFBgUIwa0lAgt3z5EroanHucMIOepcOQH+7GvZXrTfsxfxK5FJF6VCcDqT1UteCxzPMu29isugKo4nwZD7/jC/iXRXks9fMjjg3/bbiVJQcsIMrKhijd4pjMFjGLauz86/K55x+CcNuyGhaIdIdqt2mXnwfRX7uUlf3dushPZwtM7KpHtfQtBq4DcEsjqBqt6XYROmvx2fTenjdfo1vht37JLKi0KNqb+Nk9HJC2RQMHy+lf/OwsytbGyt3UB/2Vt7n4SqvGLyhXccU4sniyL9gDkjodB8bHTx7374rASDzjEfkT+SIbntdDQwQ+MFKiArqxOCKSiCLYgzxXdbGBhFp/pPkZJLArc7Sv6zpO8GUMjvtDPRpOEHcAU0UqIjvZPfYkSZoyuLXB0XOSdNQQ12S8OcR4fGlDMr2StjIbdKWa1xiMMa9AdXDD0B5uYn5jDX5Mfs1mRFySnp9Wd/PdecP3L6w09qGEe7LMSbD1ka79wyUZNcAKG1iRwtZrI2Bt/lrT1sEAL1HdEtEwX/0mBJoUzuopNoIito8EYwLiIzE+Bnlm6Yj+cQ1vVhxShUDIBxBbOJIiTtBrEqIQvcWABKQ5jns7ogWPA4K5JJUaRc5Q0ZSMd0iEwsUzVdQJfnSFP1h0YSjAtmLRX/N14Ut1E9UTbmpQdhC4+DwvPZClvpiinEdKo8CJcsRVoBEzWHhLSkLnSDsQvFC+RPkFiyITMKbuGpOItTosa81olliJBH/zG+4I+fR1jeWf8UfPAoqehON/dzdlGrGanNaqfU5tT1xMLccWyi18trfP7foL8/mjD0C8bMc4PL/sLiaDIRc6xBoOe0eCZWIpyC4k8onTyfX8zSef21jhEm642z03OFRiVTQN2zgWtrpSuqY4EV1+R24I0TIuzUKQJzcPqOmZIAXisLgIn2jQ7PM9yR8evfRTC9efY7yhAUoqD/7rmGTU0DZg9wrivFv1cyLGafBqXZhU+ZiyWz3S8kbUwpYFOL1MH4zTK/jUYOpaue34V3SlYnWB2RtzJocpC1eNSOgdUbHHnJzOIAful8JTjr4nSmvMKWpziwGAHoCtakapYHk9qJu8jLkX3u04hP2yVjLN5TO/aZXFdegTF5UNgA1f2IwYZNA0ofs/6ts54nlEUdkS5ibffVH5IHbHZi5AqFquDjK3NRHuBp523NxZTsHxrkBre28InXXrsP em0lar@em0lar.de
    ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAACAQDR9Kp84lHQRnaWU6gd8MHppZD3pQCI2TCeGF/kHm/A/kqADWqtTWjnD5ad1ZhOTSThCF35VGH3ICdnSCHh0uAHV7eK3GDjhxdrIJHY/WiubEpQJcS5OX/qTEn6QrPDIAZy2ykdHX7XrNWDGOlxpTjkPpHJmmDIQTZn/mMADuhVhIm03aFyVbUxpHSU+v7N8yxV5RehIw0RTy+qSjWcthDgTGPjPk1a2sElNVbsgF4VhqpdUfzG0BQCqr+zPDbeH66+gumDPXC5Pw4NQB596UWPDKaQv7juzveiPTpIjhTfpoWBjCmexGPbSYecXNee61NXe6HsGrGLtw/pRLEYVYH0ecU/b0A7TGd2gznKBgvk8xXoxkqHbDPoCPqC3moPD3BwCXTGNi6DBDAquC/Ho266AgZ+z83mP7TuDJmZ/F4f/glbb2hdZ6ITDS7Dvd+jGlw6UXlKeZThHOy+B1c9at4FeyQs6JBd4P5RwekUCF45gk0RfRu1+HE3YOXbN1s1DRXJs689DaBzTbD9rhROEjZgNT/m0VxC6w2i6WRvxcEvy+wL4HyJxdSK0MMVhZJza4MOB7qLvIq8z3L9kLDrKh6R49m+LsH7NCS9gh0wAH17E2cImSoX4IiRemn39oKZTplAwvvaGNXOmH/SqeZlGpYOL9Yn9nE5mC10/5In/KIZMQ== openpgp:0xF5B75815
  sudo: yes

# Users who are allowed to read/write the password-repo. has the same syntax as the users-list above
password_users:
- name: 'test'
  state: 'absent'

ansible_python_interpreter: "/usr/bin/python3"

motd_path: ../../../templates/motd_knot

synapse_database_host: "localhost"
synapse_database_database: "synapse"
synapse_database_user: "synapse"
synapse_database_password: "{{ lookup('passwordstore', 'infra/matrix/db create=true') }}"
synapse_registration_shared_secret: "{{ lookup('passwordstore', 'infra/matrix/registration') }}"
synapse_macaroon_secret_key: "{{ lookup('passwordstore', 'infra/matrix/macaroon') }}"
synapse_form_secret: "{{ lookup('passwordstore', 'infra/matrix/form') }}"
synapse_signing_key: "{{ lookup('passwordstore', 'infra/matrix/signing') }}"
synapse_allow_public_rooms_over_federation: true
synapse_enable_group_creation: true
synapse_enable_registration: true
synapse_domain: "{{ base_url }}"
synapse_server_fqdn_matrix: "matrix.{{ synapse_domain }}"
synapse_pip_version: "1.12.4"
synapse_auto_join_rooms:
  - "#grosse_halle:{{ base_url }}"
  - "#allgemein:{{ base_url }}"
synapse_email_enabled: true
synapse_email_smtp_host: "{{ lookup('passwordstore', 'infra/mail subkey=url') }}"
synapse_email_smtp_port: 587
synapse_email_smtp_user: "{{ lookup('passwordstore', 'infra/mail subkey=user') }}"
synapse_email_smtp_password: "{{ lookup('passwordstore', 'infra/mail') }}"
synapse_email_smtp_require_transport_security: no
synapse_email_client_base_url: "https://chat.{{ base_url }}"

synapse_http_listener_port: '85'
synapse_federation_listener_port: '86'

synapse_app_service_config_files:
  - /etc/matrix-appservice-irc/appservice-registration-irc.yaml

riot_installation_path: "/var/www/riot-web"
riot_version: "1.5.15"

# TODO: setup appservices
#synapse_app_service_config_files:

murmur_registry_password: "{{ lookup('passwordstore', 'infra/murmur/registry create=true') }}"

pgadmin_password: "{{ lookup('passwordstore', 'infra/pgadmin create=true') }}"

irc_hs_token: "{{ lookup('passwordstore', 'infra/irc-bridge subkey=hs_token') }}"
irc_as_token: "{{ lookup('passwordstore', 'infra/irc-bridge subkey=as_token') }}"

pretix_db_password: "{{ lookup('passwordstore', 'infra/pretix/db create=true') }}"

mail_password: "{{ lookup('passwordstore', 'infra/mail') }}"

maubot_unshared_secret: "{{ lookup('passwordstore', 'infra/maubot/unshared') }}"
maubot_admin_password: "{{ lookup('passwordstore', 'infra/maubot/admin') }}"

nginx_remove_default_vhost: true
nginx_user: www-data
nginx_vhosts:
  - listen: "81"  # Website
    server_name: "_"
    state: "present"
    filename: "default.conf"
    extra_parameters: |
      location / {
          root   /var/www/website;
          index  index.html index.htm;
      }

      location ^~/.well-known/ {
          default_type "text/plain";
          root   /var/www;
      }

  - listen: "82"  # Wiki
    server_name: "_"
    root: "/var/www/dokuwiki"
    index: "doku.php"
    state: "present"
    template: "{{ nginx_vhost_template }}"
    filename: "dokuwiki.conf"
    extra_parameters: |
      client_max_body_size 4M;
      client_body_buffer_size 128k;

      location ~ /(conf/|bin/|inc/|install.php) { deny all; }

      location ~ ^/data/ { internal ; }

      location ~ ^/lib.*\.(js|css|gif|png|ico|jpg|jpeg)$ {
        expires 365d;
      }

      location / { try_files $uri $uri/ @dokuwiki; }

      location @dokuwiki {
        # rewrites "doku.php/" out of the URLs if you set the userwrite setting to .htaccess in dokuwiki config page
        rewrite ^/_media/(.*) /lib/exe/fetch.php?media=$1 last;
        rewrite ^/_detail/(.*) /lib/exe/detail.php?media=$1 last;
        rewrite ^/_export/([^/]+)/(.*) /doku.php?do=export_$1&id=$2 last;
        rewrite ^/(.*) /doku.php?id=$1&$args last;
      }

      location ~ \.php$ {
        try_files $uri $uri/ /doku.php;
        include fastcgi_params;
        fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
        fastcgi_param REDIRECT_STATUS 200;
        fastcgi_pass 127.0.0.1:9000;
      }
  - listen: "88"  # Wiki
    server_name: "_"
    root: "/var/www/riot-web"
    index: "doku.php"
    state: "present"
    template: "{{ nginx_vhost_template }}"
    filename: "riot-web.conf"
    extra_parameters: |
      location / {
          root   /var/www/riot-web;
          index  index.html index.htm;
      }

php_date_timezone: "Europe/Berlin"
php_webserver_daemon: nginx
php_enable_php_fpm: true
php_use_managed_ini: true
php_default_version_debian: "7.4"

dokuwiki_title: "{{ base_url }} Wiki"
dokuwiki_base: /var/www/dokuwiki
dokuwiki_savedir: "{{ dokuwiki_base }}/data"
dokuwiki_plugins:
- name: tag
  src: https://github.com/dokufreaks/plugin-tag/tarball/master
- name: pagelist
  src: https://github.com/dokufreaks/plugin-pagelist/tarball/master
- name: smtp
  src: https://github.com/splitbrain/dokuwiki-plugin-smtp/tarball/master
- name: sqlite
  src: https://github.com/cosmocode/sqlite/tarball/master
- name: nspages
  src: https://github.com/gturri/nspages/tarball/master
- name: move
  src: https://github.com/michitux/dokuwiki-plugin-move/tarball/master
- name: icalevents
  src: https://github.com/real-or-random/dokuwiki-plugin-icalevents/releases/download/2017-06-16/dokuwiki-plugin-icalevents-2017-06-16.zip
  direct: yes

dokuwiki_plugins_remove:
  - name: authad
  - name: authldap
  - name: authmysql
  - name: authpdo
  - name: authpgsql
  - name: popularity
dokuwiki_provision: true
dokuwiki_disableactions:
dokuwiki_acl_all: 1
dokuwiki_acl_user: 8
dokuwiki_language: de-informal
dokuwiki_local:
  - name: "['userewrite']"
    value: 1
  - name: "['subscribers']"
    value: 1
  - name: "['useslash']"
    value: 1
  - name: "['mailfrom']"
    value: "'wiki@chaos.jetzt'"
  - name: "['plugin']['smtp']['smtp_host']"
    value: "'{{ lookup('passwordstore', 'infra/mail subkey=url') }}'"
  - name: "['plugin']['smtp']['smtp_port']"
    value: 465
  - name: "['plugin']['smtp']['smtp_ssl']"
    value: "'ssl'"
  - name: "['plugin']['smtp']['auth_user']"
    value: "'{{ lookup('passwordstore', 'infra/mail subkey=user') }}'"
  - name: "['plugin']['smtp']['auth_pass']"
    value: "'{{ lookup('passwordstore', 'infra/mail') }}'"
  - name: "['plugin']['smtp']['localdomain']"
    value: "'chaos.jetzt'"
  - name: "['plugin']['tag']['toolbar_icon']"
    value: 1
  - name: "['plugin']['icalevents']['locationUrlPrefix']"
    value: "''"
  - name: "['plugin']['icalevents']['template:default']"
    value: "'=== {date}: {summary} ===\n**Location**: {location_link}\n{description}'"
  - name: "['plugin']['icalevents']['template:list']"
    value: "'=== {date}: {summary} ===\n**<sup>Location: {location}</sup>**\n{description}'"
  - name: "['plugin']['icalevents']['template:custom1']"
    value: "'=== {date}: {summary} ===\n{description}\n**Wo?**: {location_link}'"

redis_requirepass: "{{ lookup('passwordstore', 'infra/redis') }}"

pretix_version: "3.7.0"
pretix_bind_address: "0.0.0.0:83" # TODO: Change to 127.0.0.1 when traefik is not running in docker anymore
pretix_base_path: "/opt/pretix"
pretix_config_path: "/etc/traefik"
pretix_gunicorn_worker: 2
pretix_celery_concurrency: 4
pretix_pretix_instance_name: "{{ base_url }} Pretix"
pretix_pretix_url: "https://pretix.{{ base_url }}"
pretix_database_backend: "postgresql"
pretix_database_name: "pretix"
pretix_database_user: "pretix"
pretix_database_password: "{{ lookup('passwordstore', 'infra/pretix/db') }}"
pretix_database_host: "localhost"
pretix_database_port: 5432
pretix_mail_from: "pretix@{{ base_url }}"
pretix_mail_host: "smtp.mailbox.org"
pretix_mail_user: "mail@{{ base_url }}"
pretix_mail_password: "{{ lookup('passwordstore', 'infra/mail') }}"
pretix_mail_port: 465
pretix_mail_ssl: on
pretix_django_secret: "{{ lookup('passwordstore', 'infra/pretix/secret') }}"
pretix_redis_location: "redis://:{{ lookup('passwordstore', 'infra/redis') }}@localhost:6379/0"
pretix_celery_broker: "redis://:{{ lookup('passwordstore', 'infra/redis') }}@localhost:6379/1"
pretix_celery_backend: "redis://:{{ lookup('passwordstore', 'infra/redis') }}@localhost:6379/2"

postgresql_python_library: python3-psycopg2
postgresql_users:
  - name: "{{ pretix_database_user }}"
    password: "{{ lookup('passwordstore', 'infra/pretix/db') }}"
  - name: "{{ synapse_database_user }}"
    password: "{{ synapse_database_password }}"
postgresql_databases:
  - name: "{{ pretix_database_name }}"
    owner: "{{ pretix_database_user }}"
  - name: "{{ synapse_database_database }}"
    owner: "{{ synapse_database_user }}"
    lc_collate: 'C'
    lc_ctype: 'C'

nodejs_install_npm_user: "root"
murmur_icesecretread: "secret"
murmur_welcometext: "Welcome on the {{ base_url }}-mumble server running murmur. Enjoy your stay!"
murmur_bandwidth: "128000"
murmur_sslcert: "/etc/ssl/certs/{{ base_url }}.crt"
murmur_sslkey: "/etc/ssl/private/{{ base_url }}.key"
murmur_registername: no


mumble_web: yes
mumble_web_path: "/usr/lib/node_modules/mumble-web"
# to define use yaml multiline string
mumble_web_config: ""
mumble_web_supplementary_groups: "ssl-cert"
mumble_web_listen: "84"
mumble_web_ssl_activated: False
mumble_web_ssl_target: True

traefik_version: "v2.2.1"
traefik_base_path: "/var/lib/traefik"
traefik_config_directory: "/etc/traefik"
traefik_tls_letsencrypt_challenges_http:
  enable: yes
  email: "mail@{{ base_url }}"
  name: "le_http" # Name of the certificate resolver
  entryPoint: "http"
  storage: "{{ traefik_config_directory }}/acme.json"
traefik_default_cert_resovler: "le_http"
traefik_middlewares_dashboard_authentication:
  enable: yes
  name: "dashboard_authentication"
  realm: "Traefik Dashboard"
  remove_header: yes
  users:
    - "admin:$apr1$ZOeQE6bE$NXEahNWS962G8.lTh0P180"
    - "simeon:$apr1$c7/V5Mhy$vzozg29TxnYXfzZ1deqm1/"
    - "em0lar:$apr1$h8hfBKva$F/yHCivbn8V3tIahYaNQE/"