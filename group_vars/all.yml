---
users:
- name: 'n0emis'
  state: 'present'
  public_key: 'ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIEcOPtW5FWNIdlMQFoqeyA1vHw+cA8ft8oXSbXPzQNL9'
  sudo: yes
- name: 'labcode'
  state: 'present'
  public_key: 'ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAACAQDvUrs1ly5WplOMwZONxazvgfG+7uyPDRYPAdipg0qg7a8JU9Zj29hUIYhUJXzRDXQDH8cNHVfa8EMy7GwOA3wDpm7vWk9ty89XjsNTqmGtmFOhwhaAe/XG2ltEUe+BP8D+JIld5w/Gdb+ZDAsGvFNcLn+nCzT5D8W5pR6wY25gG36Vm3YsVaWy38qC9OqgbJGWZM5x7d6LpKP3oBthKqw33r1XBMcrvDBKlemxnKP4D6OfqqrbloHUqJpzoBzMr2QjPWqBsphXliXE43I4NINCVg7hjwt7F8mzBRSa7rOBQWhEQ5z058jMWsO1yu0HfO+2swfk6mldrxlRqZhB9EWc41h11pmVRW3LLVR+6Q5+bEEZIWeqA1mm88J25oovc225fxeKeeSha/A7sCdiLDReuZXj3CpYdWESmJaLlTrrKC0Qmt/sd5TL4pfIhccWqqnh+iNdDI9F2bASm7A95TOnf0inVZe8NpKsF3xHqFbJ96sK0xjtx4of3Fu61O9l0Mj/gaLtNO9HAe5+97bX9iTev9EIcoUKbNtU+UDxA0xbN4PRBygLWDPCfkhdDL8t2MBIAc2eBqbgK7NSvLoVrTrYy5W3tyCjZUO6M6ZipAJiaDbWCVTs2GJKMtf37N5Rmz4IiomjYZ3QGRR/Xpf82m6ufBQ6aZX7Ntx9kHc3p1Eebw== openpgp:0x150A6198'
  sudo: yes

# Users who are allowed to read/write the password-repo. has the same syntax as the users-list above
password_users:
- name: 'test'
  state: 'absent'

ansible_python_interpreter: "/usr/bin/python3"

motd_path: ../../../templates/motd_knot

synapse_db_password: "{{ lookup('passwordstore', 'infra/matrix/db create=true') }}"
synapse_registration_secret: "{{ lookup('passwordstore', 'infra/matrix/registration') }}"
synapse_macaroon_secret: "{{ lookup('passwordstore', 'infra/matrix/macaroon') }}"
synapse_form_secret: "{{ lookup('passwordstore', 'infra/matrix/form') }}"
synapse_signing_key: "{{ lookup('passwordstore', 'infra/matrix/signing') }}"

murmur_registry_password: "{{ lookup('passwordstore', 'infra/murmur/registry create=true') }}"

pgadmin_password: "{{ lookup('passwordstore', 'infra/pgadmin create=true') }}"

irc_hs_token: "{{ lookup('passwordstore', 'infra/irc-bridge subkey=hs_token') }}"
irc_as_token: "{{ lookup('passwordstore', 'infra/irc-bridge subkey=as_token') }}"

pretix_db_password: "{{ lookup('passwordstore', 'infra/pretix/db create=true') }}"

mail_password: "{{ lookup('passwordstore', 'infra/mail') }}"

maubot_unshared_secret: "{{ lookup('passwordstore', 'infra/maubot/unshared') }}"
maubot_admin_password: "{{ lookup('passwordstore', 'infra/maubot/admin') }}"

nginx_remove_default_vhost: true
nginx_user: www-data
nginx_vhosts:
  - listen: "81"  # Website
    server_name: "_"
    state: "present"
    filename: "default.conf"
    extra_parameters: |
      location / {
          root   /var/www/website;
          index  index.html index.htm;
      }

      location ^~/.well-known/ {
          default_type "text/plain";
          root   /var/www;
      }

  - listen: "82"  # Wiki
    server_name: "_"
    root: "/var/www/dokuwiki"
    index: "doku.php"
    state: "present"
    template: "{{ nginx_vhost_template }}"
    filename: "dokuwiki.conf"
    extra_parameters: |
      client_max_body_size 4M;
      client_body_buffer_size 128k;

      location ~ /(conf/|bin/|inc/|install.php) { deny all; }

      location ~ ^/data/ { internal ; }

      location ~ ^/lib.*\.(js|css|gif|png|ico|jpg|jpeg)$ {
        expires 365d;
      }

      location / { try_files $uri $uri/ @dokuwiki; }

      location @dokuwiki {
        # rewrites "doku.php/" out of the URLs if you set the userwrite setting to .htaccess in dokuwiki config page
        rewrite ^/_media/(.*) /lib/exe/fetch.php?media=$1 last;
        rewrite ^/_detail/(.*) /lib/exe/detail.php?media=$1 last;
        rewrite ^/_export/([^/]+)/(.*) /doku.php?do=export_$1&id=$2 last;
        rewrite ^/(.*) /doku.php?id=$1&$args last;
      }

      location ~ \.php$ {
        try_files $uri $uri/ /doku.php;
        include fastcgi_params;
        fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
        fastcgi_param REDIRECT_STATUS 200;
        fastcgi_pass unix:/var/run/php/php{{ php_default_version_debian }}-fpm.sock;
      }


php_webserver_daemon: nginx
php_enable_php_fpm: true
php_use_managed_ini: true
php_default_version_debian: "7.2"

dokuwiki_title: "{{ base_url }} Wiki"
dokuwiki_base: /var/www/dokuwiki
dokuwiki_savedir: "{{ dokuwiki_base }}/data"
dokuwiki_plugins:
- name: tag
  src: https://github.com/dokufreaks/plugin-tag/tarball/master
- name: pagelist
  src: https://github.com/dokufreaks/plugin-pagelist/tarball/master
- name: smtp
  src: https://github.com/splitbrain/dokuwiki-plugin-smtp/tarball/master
dokuwiki_plugins_remove:
  - name: authad
  - name: authldap
  - name: authmysql
  - name: authpdo
  - name: authpgsql
  - name: info
  - name: popularity
dokuwiki_provision: true
dokuwiki_disableactions:
dokuwiki_acl_all: 1
dokuwiki_acl_user: 8
dokuwiki_language: de-informal
dokuwiki_local:
  - name: "['userewrite']"
    value: 1
  - name: "['subscribers']"
    value: 1
  - name: "['useslash']"
    value: 1
  - name: "['mailfrom']"
    value: "'wiki@chaos.jetzt'"
  - name: "['plugin']['smtp']['smtp_host']"
    value: "'{{ lookup('passwordstore', 'infra/mail subkey=url') }}'"
  - name: "['plugin']['smtp']['smtp_port']"
    value: 465
  - name: "['plugin']['smtp']['smtp_ssl']"
    value: "'ssl'"
  - name: "['plugin']['smtp']['auth_user']"
    value: "'{{ lookup('passwordstore', 'infra/mail subkey=user') }}'"
  - name: "['plugin']['smtp']['auth_pass']"
    value: "'{{ lookup('passwordstore', 'infra/mail') }}'"
  - name: "['plugin']['smtp']['localdomain']"
    value: "'chaos.jetzt'"
  - name: "['plugin']['tag']['toolbar_icon']"
    value: 1
