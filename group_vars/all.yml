---
users:
- name: 'n0emis'
  state: 'present'
  public_key: 'ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIEcOPtW5FWNIdlMQFoqeyA1vHw+cA8ft8oXSbXPzQNL9'
  sudo: yes
- name: 'labcode'
  state: 'present'
  public_key: 'ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAACAQDvUrs1ly5WplOMwZONxazvgfG+7uyPDRYPAdipg0qg7a8JU9Zj29hUIYhUJXzRDXQDH8cNHVfa8EMy7GwOA3wDpm7vWk9ty89XjsNTqmGtmFOhwhaAe/XG2ltEUe+BP8D+JIld5w/Gdb+ZDAsGvFNcLn+nCzT5D8W5pR6wY25gG36Vm3YsVaWy38qC9OqgbJGWZM5x7d6LpKP3oBthKqw33r1XBMcrvDBKlemxnKP4D6OfqqrbloHUqJpzoBzMr2QjPWqBsphXliXE43I4NINCVg7hjwt7F8mzBRSa7rOBQWhEQ5z058jMWsO1yu0HfO+2swfk6mldrxlRqZhB9EWc41h11pmVRW3LLVR+6Q5+bEEZIWeqA1mm88J25oovc225fxeKeeSha/A7sCdiLDReuZXj3CpYdWESmJaLlTrrKC0Qmt/sd5TL4pfIhccWqqnh+iNdDI9F2bASm7A95TOnf0inVZe8NpKsF3xHqFbJ96sK0xjtx4of3Fu61O9l0Mj/gaLtNO9HAe5+97bX9iTev9EIcoUKbNtU+UDxA0xbN4PRBygLWDPCfkhdDL8t2MBIAc2eBqbgK7NSvLoVrTrYy5W3tyCjZUO6M6ZipAJiaDbWCVTs2GJKMtf37N5Rmz4IiomjYZ3QGRR/Xpf82m6ufBQ6aZX7Ntx9kHc3p1Eebw== openpgp:0x150A6198'
  sudo: yes

# Users who are allowed to read/write the password-repo. has the same syntax as the users-list above
password_users:
- name: 'test'
  state: 'absent'

ansible_python_interpreter: "/usr/bin/python3"

motd_path: ../../../templates/motd_knot

synapse_database_host: "localhost"
synapse_database_database: "synapse"
synapse_database_user: "synapse"
synapse_database_password: "{{ lookup('passwordstore', 'infra/matrix/db create=true') }}"
synapse_registration_shared_secret: "{{ lookup('passwordstore', 'infra/matrix/registration') }}"
synapse_macaroon_secret_key: "{{ lookup('passwordstore', 'infra/matrix/macaroon') }}"
synapse_form_secret: "{{ lookup('passwordstore', 'infra/matrix/form') }}"
synapse_signing_key: "{{ lookup('passwordstore', 'infra/matrix/signing') }}"
synapse_allow_public_rooms_over_federation: true
synapse_enable_group_creation: true
synapse_enable_registration: true
synapse_domain: "{{ base_url }}"
synapse_server_fqdn_matrix: "matrix.{{ synapse_domain }}"
synapse_pip_version: "1.12.4"
synapse_auto_join_rooms:
  - "#grosse_halle:{{ base_url }}"
  - "#allgemein:{{ base_url }}"
synapse_email_enabled: true
synapse_email_smtp_host: "{{ lookup('passwordstore', 'infra/mail subkey=url') }}"
synapse_email_smtp_port: 587
synapse_email_smtp_user: "{{ lookup('passwordstore', 'infra/mail subkey=user') }}"
synapse_email_smtp_password: "{{ lookup('passwordstore', 'infra/mail') }}"
synapse_email_smtp_require_transport_security: no
synapse_email_client_base_url: "https://chat.{{ base_url }}"

synapse_http_listener_port: '85'
synapse_federation_listener_port: '86'

# TODO: setup appservices
#synapse_app_service_config_files:

murmur_registry_password: "{{ lookup('passwordstore', 'infra/murmur/registry create=true') }}"

pgadmin_password: "{{ lookup('passwordstore', 'infra/pgadmin create=true') }}"

irc_hs_token: "{{ lookup('passwordstore', 'infra/irc-bridge subkey=hs_token') }}"
irc_as_token: "{{ lookup('passwordstore', 'infra/irc-bridge subkey=as_token') }}"

pretix_db_password: "{{ lookup('passwordstore', 'infra/pretix/db create=true') }}"

mail_password: "{{ lookup('passwordstore', 'infra/mail') }}"

maubot_unshared_secret: "{{ lookup('passwordstore', 'infra/maubot/unshared') }}"
maubot_admin_password: "{{ lookup('passwordstore', 'infra/maubot/admin') }}"

nginx_remove_default_vhost: true
nginx_user: www-data
nginx_vhosts:
  - listen: "81"  # Website
    server_name: "_"
    state: "present"
    filename: "default.conf"
    extra_parameters: |
      location / {
          root   /var/www/website;
          index  index.html index.htm;
      }

      location ^~/.well-known/ {
          default_type "text/plain";
          root   /var/www;
      }

  - listen: "82"  # Wiki
    server_name: "_"
    root: "/var/www/dokuwiki"
    index: "doku.php"
    state: "present"
    template: "{{ nginx_vhost_template }}"
    filename: "dokuwiki.conf"
    extra_parameters: |
      client_max_body_size 4M;
      client_body_buffer_size 128k;

      location ~ /(conf/|bin/|inc/|install.php) { deny all; }

      location ~ ^/data/ { internal ; }

      location ~ ^/lib.*\.(js|css|gif|png|ico|jpg|jpeg)$ {
        expires 365d;
      }

      location / { try_files $uri $uri/ @dokuwiki; }

      location @dokuwiki {
        # rewrites "doku.php/" out of the URLs if you set the userwrite setting to .htaccess in dokuwiki config page
        rewrite ^/_media/(.*) /lib/exe/fetch.php?media=$1 last;
        rewrite ^/_detail/(.*) /lib/exe/detail.php?media=$1 last;
        rewrite ^/_export/([^/]+)/(.*) /doku.php?do=export_$1&id=$2 last;
        rewrite ^/(.*) /doku.php?id=$1&$args last;
      }

      location ~ \.php$ {
        try_files $uri $uri/ /doku.php;
        include fastcgi_params;
        fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
        fastcgi_param REDIRECT_STATUS 200;
        fastcgi_pass unix:/var/run/php/php{{ php_default_version_debian }}-fpm.sock;
      }


php_webserver_daemon: nginx
php_enable_php_fpm: true
php_use_managed_ini: true
php_default_version_debian: "7.2"

dokuwiki_title: "{{ base_url }} Wiki"
dokuwiki_base: /var/www/dokuwiki
dokuwiki_savedir: "{{ dokuwiki_base }}/data"
dokuwiki_plugins:
- name: tag
  src: https://github.com/dokufreaks/plugin-tag/tarball/master
- name: pagelist
  src: https://github.com/dokufreaks/plugin-pagelist/tarball/master
- name: smtp
  src: https://github.com/splitbrain/dokuwiki-plugin-smtp/tarball/master
dokuwiki_plugins_remove:
  - name: authad
  - name: authldap
  - name: authmysql
  - name: authpdo
  - name: authpgsql
  - name: info
  - name: popularity
dokuwiki_provision: true
dokuwiki_disableactions:
dokuwiki_acl_all: 1
dokuwiki_acl_user: 8
dokuwiki_language: de-informal
dokuwiki_local:
  - name: "['userewrite']"
    value: 1
  - name: "['subscribers']"
    value: 1
  - name: "['useslash']"
    value: 1
  - name: "['mailfrom']"
    value: "'wiki@chaos.jetzt'"
  - name: "['plugin']['smtp']['smtp_host']"
    value: "'{{ lookup('passwordstore', 'infra/mail subkey=url') }}'"
  - name: "['plugin']['smtp']['smtp_port']"
    value: 465
  - name: "['plugin']['smtp']['smtp_ssl']"
    value: "'ssl'"
  - name: "['plugin']['smtp']['auth_user']"
    value: "'{{ lookup('passwordstore', 'infra/mail subkey=user') }}'"
  - name: "['plugin']['smtp']['auth_pass']"
    value: "'{{ lookup('passwordstore', 'infra/mail') }}'"
  - name: "['plugin']['smtp']['localdomain']"
    value: "'chaos.jetzt'"
  - name: "['plugin']['tag']['toolbar_icon']"
    value: 1

postgresql_python_library: python3-psycopg2
postgresql_users:
  - name: pretix
    password: "{{ lookup('passwordstore', 'infra/pretix/db') }}"
  - name: "{{ synapse_database_user }}"
    password: "{{ synapse_database_password }}"
postgresql_databases:
  - name: pretix
    owner: pretix
  - name: synapse
    owner: synapse
    lc_collate: 'C'
    lc_ctype: 'C'

redis_requirepass: "{{ lookup('passwordstore', 'infra/redis') }}"

pretix_version: "3.7.0"
pretix_bind_address: "0.0.0.0:83" # TODO: Change to 127.0.0.1 when traefik is not running in docker anymore
pretix_base_path: "/opt/pretix"
pretix_gunicorn_worker: 2
pretix_celery_concurrency: 4
pretix_pretix_instance_name: "{{ base_url }} Pretix"
pretix_pretix_url: "https://pretix.{{ base_url }}"
pretix_database_backend: "postgresql"
pretix_database_name: "pretix"
pretix_database_user: "pretix"
pretix_database_password: "{{ lookup('passwordstore', 'infra/pretix/db') }}"
pretix_database_host: "localhost"
pretix_database_port: 5432
pretix_mail_from: "pretix@{{ base_url }}"
pretix_mail_host: "smtp.mailbox.org"
pretix_mail_user: "mail@{{ base_url }}"
pretix_mail_password: "{{ lookup('passwordstore', 'infra/mail') }}"
pretix_mail_port: 465
pretix_mail_ssl: on
pretix_django_secret: "{{ lookup('passwordstore', 'infra/pretix/secret') }}"
pretix_redis_location: "redis://:{{ lookup('passwordstore', 'infra/redis') }}@localhost:6379/0"
pretix_celery_broker: "redis://:{{ lookup('passwordstore', 'infra/redis') }}@localhost:6379/1"
pretix_celery_backend: "redis://:{{ lookup('passwordstore', 'infra/redis') }}@localhost:6379/2"

nodejs_install_npm_user: "root"
murmur_icesecretread: "secret"
murmur_welcometext: "Welcome on the {{ base_url }}-mumble server running murmur. Enjoy your stay!"
murmur_bandwidth: "128000"
murmur_sslcert: "/etc/ssl/certs/{{ base_url }}.crt"
murmur_sslkey: "/etc/ssl/private/{{ base_url }}.key"
murmur_registername: no


mumble_web: yes
mumble_web_path: "/usr/lib/node_modules/mumble-web"
# to define use yaml multiline string
mumble_web_config: ""
mumble_web_supplementary_groups: "certs"
mumble_web_listen: "84"
mumble_web_ssl_activated: False
mumble_web_ssl_target: True

traefik_version: "v2.2.1"
traefik_base_path: "/var/lib/traefik"
traefik_config_directory: "/etc/traefik"
traefik_tls_letsencrypt_challenges_http:
  enable: yes
  email: "mail@{{ base_url }}"
  name: "le_http" # Name of the certificate resolver
  entryPoint: "http"
  storage: "{{ traefik_config_directory }}/acme.json"
traefik_default_cert_resovler: "le_http"
traefik_middlewares_dashboard_authentication:
  enable: yes
  name: "dashboard_authentication"
  realm: "Traefik Dashboard"
  remove_header: yes
  users:
    - "admin:$apr1$ZOeQE6bE$NXEahNWS962G8.lTh0P180"
    - "simeon:$apr1$c7/V5Mhy$vzozg29TxnYXfzZ1deqm1/"
    - "em0lar:$apr1$h8hfBKva$F/yHCivbn8V3tIahYaNQE/"